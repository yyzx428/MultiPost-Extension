<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiPost Extension - 文件操作测试</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: #fafafa;
        }
        .section h3 {
            margin-top: 0;
            color: #555;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #666;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #005a87;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .path-input {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .path-input input {
            flex: 1;
            margin-right: 10px;
        }
        .path-input button {
            padding: 6px 12px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MultiPost Extension - 文件操作测试</h1>
        
        <!-- 状态检查 -->
        <div class="section">
            <h3>🔍 扩展状态检查</h3>
            <div id="extensionStatus" class="status info">正在检查扩展状态...</div>
            <button onclick="checkExtensionStatus()">重新检查</button>
            <button onclick="detectPlatform()">检测当前平台</button>
        </div>

        <!-- 百度云分享测试 -->
        <div class="section">
            <h3>📁 百度云分享测试</h3>
            <div class="form-group">
                <label>文件路径（每行一个）：</label>
                <div id="pathInputs">
                    <div class="path-input">
                        <input type="text" placeholder="例如：我的手抄报" value="我的手抄报">
                        <button onclick="removePath(this)">删除</button>
                    </div>
                    <div class="path-input">
                        <input type="text" placeholder="例如：041" value="041">
                        <button onclick="removePath(this)">删除</button>
                    </div>
                </div>
                <button onclick="addPath()">添加路径</button>
            </div>
            
            <div class="form-group">
                <label>有效期：</label>
                <select id="validPeriod">
                    <option value="1天">1天</option>
                    <option value="7天" selected>7天</option>
                    <option value="30天">30天</option>
                    <option value="365天">365天</option>
                    <option value="永久有效">永久有效</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>提取码：</label>
                <select id="extractCodeType" onchange="toggleCustomCode()">
                    <option value="不设置">不设置</option>
                    <option value="随机生成" selected>随机生成</option>
                    <option value="自定义">自定义</option>
                </select>
            </div>
            
            <div class="form-group" id="customCodeGroup" style="display:none;">
                <label>自定义提取码：</label>
                <input type="text" id="customCode" placeholder="请输入4位提取码" maxlength="4">
            </div>
            
            <button onclick="testBaiduShare()" id="shareBtn">创建分享</button>
            <button onclick="testQuickShare()">快速分享（默认配置）</button>
        </div>

        <!-- 操作结果 -->
        <div class="section">
            <h3>📋 操作结果</h3>
            <div id="result" class="result">暂无操作结果</div>
            <button onclick="clearResult()">清空结果</button>
        </div>

        <!-- 使用说明 -->
        <div class="section">
            <h3>📖 使用说明</h3>
            <ol>
                <li>确保已安装 MultiPost Extension 浏览器扩展</li>
                <li>在百度网盘页面打开此测试页面（可通过书签或控制台运行）</li>
                <li>配置文件路径和分享参数</li>
                <li>点击"创建分享"按钮执行操作</li>
                <li>查看操作结果和日志信息</li>
            </ol>
            
            <h4>代码示例：</h4>
            <div class="result">
// 基础用法
const result = await window.multipostExtension.fileOperation({
    platform: 'baiduyun',
    operation: 'share',
    params: {
        paths: ['我的手抄报', '041'],
        shareConfig: {
            validPeriod: '7天',
            extractCodeType: '随机生成'
        }
    }
});

// 便捷方法
const result = await window.createBaiduYunShare(
    ['我的手抄报', '041'], 
    {
        validPeriod: '7天',
        extractCodeType: '随机生成'
    }
);
            </div>
        </div>
    </div>

    <script>
        let extensionReady = false;

        // 检查扩展状态
        function checkExtensionStatus() {
            const statusDiv = document.getElementById('extensionStatus');
            
            if (window.multipostExtension) {
                statusDiv.className = 'status success';
                statusDiv.textContent = '✅ MultiPost Extension 已就绪，文件操作功能可用';
                extensionReady = true;
            } else {
                statusDiv.className = 'status error';
                statusDiv.textContent = '❌ MultiPost Extension 未检测到，请确保已安装并启用扩展';
                extensionReady = false;
            }
        }

        // 检测当前平台
        function detectPlatform() {
            const hostname = window.location.hostname;
            const statusDiv = document.getElementById('extensionStatus');
            
            let platform = 'unknown';
            if (hostname.includes('pan.baidu.com')) platform = 'baiduyun';
            else if (hostname.includes('aliyundrive.com')) platform = 'aliyun';
            else if (hostname.includes('onedrive.live.com')) platform = 'onedrive';
            
            const message = `当前平台: ${platform} (${hostname})`;
            addResult('info', `平台检测: ${message}`);
        }

        // 添加路径输入框
        function addPath() {
            const pathInputs = document.getElementById('pathInputs');
            const div = document.createElement('div');
            div.className = 'path-input';
            div.innerHTML = `
                <input type="text" placeholder="输入路径">
                <button onclick="removePath(this)">删除</button>
            `;
            pathInputs.appendChild(div);
        }

        // 删除路径输入框
        function removePath(button) {
            button.parentElement.remove();
        }

        // 切换自定义提取码输入
        function toggleCustomCode() {
            const select = document.getElementById('extractCodeType');
            const group = document.getElementById('customCodeGroup');
            group.style.display = select.value === '自定义' ? 'block' : 'none';
        }

        // 获取路径数组
        function getPaths() {
            const inputs = document.querySelectorAll('#pathInputs input');
            return Array.from(inputs)
                .map(input => input.value.trim())
                .filter(path => path.length > 0);
        }

        // 测试百度云分享
        async function testBaiduShare() {
            if (!extensionReady) {
                addResult('error', '扩展未就绪，无法执行操作');
                return;
            }

            const shareBtn = document.getElementById('shareBtn');
            shareBtn.disabled = true;
            shareBtn.textContent = '操作中...';

            try {
                const paths = getPaths();
                if (paths.length === 0) {
                    throw new Error('请至少输入一个路径');
                }

                const validPeriod = document.getElementById('validPeriod').value;
                const extractCodeType = document.getElementById('extractCodeType').value;
                const customCode = document.getElementById('customCode').value;

                addResult('info', `开始创建分享: ${paths.join(' -> ')}`);

                const request = {
                    platform: 'baiduyun',
                    operation: 'share',
                    params: {
                        paths,
                        shareConfig: {
                            validPeriod,
                            extractCodeType,
                            ...(extractCodeType === '自定义' && customCode ? { customCode } : {})
                        }
                    }
                };

                const result = await window.multipostExtension.fileOperation(request);
                
                if (result.success) {
                    addResult('success', '分享创建成功！');
                    addResult('info', `执行时间: ${result.executionTime}ms`);
                    addResult('data', JSON.stringify(result.data, null, 2));
                    if (result.logs.length > 0) {
                        addResult('logs', '操作日志:\n' + result.logs.map(log => 
                            `[${new Date(log.timestamp).toLocaleTimeString()}] ${log.level.toUpperCase()}: ${log.message}`
                        ).join('\n'));
                    }
                } else {
                    addResult('error', '分享创建失败');
                    addResult('data', JSON.stringify(result, null, 2));
                }

            } catch (error) {
                addResult('error', `操作失败: ${error.message}`);
                console.error('分享操作失败:', error);
            } finally {
                shareBtn.disabled = false;
                shareBtn.textContent = '创建分享';
            }
        }

        // 快速分享测试
        async function testQuickShare() {
            if (!window.createBaiduYunShare) {
                addResult('error', '便捷方法不可用');
                return;
            }

            try {
                const paths = getPaths();
                if (paths.length === 0) {
                    throw new Error('请至少输入一个路径');
                }

                addResult('info', `使用便捷方法创建分享: ${paths.join(' -> ')}`);

                const result = await window.createBaiduYunShare(paths);
                
                addResult('success', '快速分享创建成功！');
                addResult('data', JSON.stringify(result.data, null, 2));

            } catch (error) {
                addResult('error', `快速分享失败: ${error.message}`);
            }
        }

        // 添加结果到显示区域
        function addResult(type, content) {
            const resultDiv = document.getElementById('result');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = {
                'info': '[INFO]',
                'success': '[SUCCESS]',
                'error': '[ERROR]',
                'data': '[DATA]',
                'logs': '[LOGS]'
            }[type] || '[LOG]';
            
            resultDiv.textContent += `${timestamp} ${prefix} ${content}\n\n`;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }

        // 清空结果
        function clearResult() {
            document.getElementById('result').textContent = '暂无操作结果';
        }

        // 监听扩展就绪事件
        window.addEventListener('multipostExtensionReady', (event) => {
            addResult('info', `扩展就绪事件: ${JSON.stringify(event.detail)}`);
            checkExtensionStatus();
        });

        // 页面加载完成后检查状态
        document.addEventListener('DOMContentLoaded', () => {
            // 延迟检查，确保扩展有时间初始化
            setTimeout(checkExtensionStatus, 1000);
        });

        // 开发环境调试
        if (window.multipostExtensionDebug) {
            console.log('🔧 开发调试工具已就绪');
            console.log('使用 window.multipostExtensionDebug.checkStatus() 检查状态');
            console.log('使用 window.multipostExtensionDebug.testShare() 快速测试');
        }
    </script>
</body>
</html> 